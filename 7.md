Седьмая группа вопросов посвящена манипулированию данными (**DML** — Data Manipulation Language), использованию встроенных функций и методам оптимизации производительности запросов.

---

### 1. Команды манипулирования данными. Применение подзапросов в INSERT

Команды DML используются для изменения содержимого таблиц. К ним относятся `INSERT`, `UPDATE` и `DELETE`.

**Команда INSERT** добавляет новые строки в таблицу. При использовании подзапроса она позволяет копировать данные из одной таблицы в другую.
*   **Синтаксис:** `INSERT INTO имя_таблицы (столбцы) SELECT ...`
*   **Пример:** Нужно перенести всех уволенных сотрудников в архивную таблицу.
    ```sql
    INSERT INTO employees_archive (id, name, fire_date)
    SELECT id, name, CURRENT_DATE
    FROM employees
    WHERE status = 'fired';
    ```
    *Здесь подзапрос SELECT заменяет стандартный блок VALUES, позволяя вставить сразу множество строк.*

---

### 2. Команды манипулирования данными. Применение подзапросов в DELETE

**Команда DELETE** удаляет строки из таблицы на основе условия. Подзапрос в условии позволяет удалять данные, основываясь на информации из связанных таблиц.
*   **Синтаксис:** `DELETE FROM имя_таблицы WHERE столбец IN (подзапрос)`
*   **Пример:** Удалить всех клиентов, которые не сделали ни одного заказа за последний год.
    ```sql
    DELETE FROM customers
    WHERE id NOT IN (
        SELECT DISTINCT customer_id 
        FROM orders 
        WHERE order_date > '2023-01-01'
    );
    ```

---

### 3. Команды манипулирования данными. Применение подзапросов в UPDATE

**Команда UPDATE** изменяет значения в уже существующих строках. Подзапросы могут использоваться как в условии `WHERE`, так и в правой части выражения `SET` для вычисления нового значения.
*   **Синтаксис:** `UPDATE таблица SET столбец = (подзапрос) WHERE ...`
*   **Пример:** Установить цену товара равной средней цене в его категории.
    ```sql
    UPDATE products p
    SET price = (
        SELECT AVG(price) 
        FROM products 
        WHERE category_id = p.category_id
    )
    WHERE p.status = 'recalculate';
    ```
    *Это пример коррелированного (связанного) подзапроса, который выполняется для каждой обновляемой строки.*

---

### 4. Встроенные функции SQL

Встроенные функции позволяют обрабатывать данные прямо в запросе. Они делятся на группы:

1.  **Математические:** `ABS()` (модуль), `ROUND()` (округление), `CEIL()` (вверх), `FLOOR()` (вниз), `RAND()` (случайное число).
2.  **Строковые:** 
    *   `UPPER()` / `LOWER()` — изменение регистра.
    *   `CONCAT()` — объединение строк.
    *   `SUBSTR()` / `SUBSTRING()` — извлечение подстроки.
    *   `LENGTH()` — длина строки.
    *   `TRIM()` — удаление пробелов по краям.
3.  **Дата и время:** 
    *   `NOW()` / `CURRENT_TIMESTAMP` — текущая дата и время.
    *   `DATEDIFF()` — разница между датами.
    *   `EXTRACT()` — получение части даты (год, месяц, день).
4.  **Функции преобразования и обработки NULL:**
    *   `CAST()` / `CONVERT()` — смена типа данных.
    *   `COALESCE(val1, val2)` — возвращает первый не-NULL аргумент (полезно для замены пустоты значением по умолчанию).

---

### 5. Оператор EXPLAIN: назначение и пример

**EXPLAIN** — это служебная команда, которая показывает **план выполнения запроса**, построенный оптимизатором СУБД. Она не выполняет сам запрос, а объясняет, как СУБД будет искать данные.

**Что можно узнать из EXPLAIN:**
*   Используются ли индексы или происходит полное сканирование таблицы (`Full Table Scan`).
*   В каком порядке соединяются таблицы (JOIN).
*   Примерное количество строк, которые придется обработать СУБД.

**Пример:**
```sql
EXPLAIN SELECT name FROM users WHERE email = 'test@mail.ru';
```
**Результат (примерный):**
*   `type: const` (или `index`) — это хорошо, поиск быстрый.
*   `type: ALL` — это плохо, СУБД просматривает всю таблицу целиком. Нужно добавить индекс на колонку `email`.

---

### 6. Способы оптимизации запросов

Оптимизация направлена на снижение нагрузки на сервер и ускорение выдачи результата. Основные методы:

1.  **Использование индексов:** Создание индексов на поля, которые часто используются в `WHERE`, `JOIN` и `ORDER BY`.
2.  **Отказ от `SELECT *`:** Выбирать нужно только те столбцы, которые действительно необходимы. Это экономит память и пропускную способность сети.
3.  **Оптимизация условий:** 
    *   Избегать использования функций в левой части условия (например, вместо `WHERE YEAR(date) = 2023` лучше использовать `WHERE date BETWEEN '2023-01-01' AND '2023-12-31'`), так как функции отключают использование индексов.
4.  **Замена `IN` на `EXISTS`:** В некоторых СУБД подзапросы с `EXISTS` работают быстрее при проверке наличия данных в больших таблицах.
5.  **Использование `LIMIT`:** Если пользователю нужны только первые 10 записей, не нужно заставлять сервер возвращать тысячи.
6.  **Нормализация и денормализация:** 
    *   Нормализация убирает дубли и ускоряет запись.
    *   Денормализация (сознательное введение избыточности) иногда применяется в высоконагруженных системах для ускорения чтения (чтобы избежать тяжелых `JOIN`).
7.  **Анализ плана выполнения:** Регулярное использование `EXPLAIN` для выявления "узких мест".
