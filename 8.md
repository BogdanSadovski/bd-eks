Восьмая группа вопросов посвящена **DDL (Data Definition Language)** — языку определения данных, а также **программированию на стороне сервера** (триггеры, процедуры, функции). Эти инструменты позволяют управлять структурой БД и автоматизировать бизнес-логику внутри самой СУБД.

---

### 1. Команды SQL для работы с таблицами (DDL)

Создание, удаление и модификация таблиц — основные задачи при проектировании и эксплуатации БД.

*   **Создание таблиц (CREATE TABLE):**
    Используется для определения структуры: имен столбцов, их типов и ограничений (Constraints).
    ```sql
    CREATE TABLE Students (
        StudentID INT PRIMARY KEY,         -- Первичный ключ
        FullName VARCHAR(100) NOT NULL,   -- Обязательное поле
        BirthDate DATE,
        GroupID INT,
        -- Установление внешнего ключа (связывание таблиц):
        FOREIGN KEY (GroupID) REFERENCES Groups(ID)
    );
    ```
*   **Удаление таблиц (DROP TABLE):**
    Полное удаление таблицы и всех её данных из БД.
    `DROP TABLE Students;`
*   **Модификация таблиц (ALTER TABLE):**
    Используется для изменения структуры уже существующей таблицы.
    *   *Добавление колонки:* `ALTER TABLE Students ADD Email VARCHAR(50);`
    *   *Изменение типа данных:* `ALTER TABLE Students ALTER COLUMN FullName VARCHAR(150);`
    *   *Удаление колонки:* `ALTER TABLE Students DROP COLUMN BirthDate;`

---

### 2. Команды SQL для работы с индексами

Индексы нужны для ускорения поиска. Они работают как алфавитный указатель в книге.

*   **Создание индекса:**
    `CREATE INDEX idx_student_name ON Students(FullName);`
    *Уникальный индекс (запрещает дубликаты):* `CREATE UNIQUE INDEX idx_email ON Students(Email);`
*   **Изменение/Восстановление индекса:**
    В стандартном SQL нет прямой команды «изменить индекс». Обычно он удаляется и создается заново. Однако в MS SQL Server есть команда `ALTER INDEX ... REBUILD` для дефрагментации и восстановления производительности.
*   **Удаление индекса:**
    `DROP INDEX idx_student_name;` (В некоторых СУБД: `DROP INDEX idx_name ON TableName;`)

---

### 3. Команды SQL для работы с представлениями (Views)

**Представление** — это сохраненный запрос, который для пользователя выглядит как обычная таблица. Оно не хранит данные физически (кроме материализованных представлений).

*   **Создание:**
    ```sql
    CREATE VIEW ExcellentStudents AS
    SELECT FullName, GroupID FROM Students WHERE Grade = 5;
    ```
*   **Изменение (OR REPLACE или ALTER):**
    `CREATE OR REPLACE VIEW ExcellentStudents AS ...` (меняет логику фильтрации).
*   **Удаление:**
    `DROP VIEW ExcellentStudents;`

---

### 4. Назначение и синтаксис триггеров

**Триггер** — это хранимая процедура особого типа, которая **автоматически** запускается сервером при наступлении определенного события (INSERT, UPDATE или DELETE).

*   **Назначение:** Проверка сложных условий целостности, автоматическое ведение логов (журнализация), каскадные обновления.
*   **Создание (пример для PostgreSQL/Oracle):**
    ```sql
    CREATE TRIGGER trg_audit_salary
    AFTER UPDATE ON Employees
    FOR EACH ROW
    EXECUTE FUNCTION log_salary_change();
    ```
*   **Модификация:** Обычно через `CREATE OR REPLACE`.
*   **Удаление:** `DROP TRIGGER name ON TableName;`

---

### 5. Синтаксис создания хранимых процедур

**Хранимая процедура** — это именованный блок кода SQL, который компилируется и хранится на сервере. Она может принимать входные параметры и возвращать выходные.

*   **Синтаксис (на примере MS SQL Server):**
    ```sql
    CREATE PROCEDURE GetStudentGrades
        @StudentName VARCHAR(50) -- Входной параметр
    AS
    BEGIN
        SELECT Grade FROM Exams 
        WHERE StudentID = (SELECT id FROM Students WHERE name = @StudentName);
    END;
    ```
*   **Вызов:** `EXEC GetStudentGrades 'Иван Иванов';`

---

### 6. Синтаксис создания функций, определенных пользователем (UDF)

Функции похожи на процедуры, но они **всегда возвращают значение** и могут использоваться внутри обычных SELECT-запросов.

*   **Синтаксис (на примере PostgreSQL):**
    ```sql
    CREATE FUNCTION CalculateTax(price NUMERIC) 
    RETURNS NUMERIC AS $$
    BEGIN
        RETURN price * 0.13;
    END;
    $$ LANGUAGE plpgsql;
    ```
*   **Использование:** `SELECT Name, CalculateTax(Salary) FROM Employees;`

---

### 7. Основные элементы языка Transact-SQL (T-SQL)

**T-SQL** — это расширение SQL от Microsoft. Оно превращает декларативный SQL в полноценный язык программирования.

**Основные элементы:**
1.  **Переменные:** Объявляются через `DECLARE`, начинаются с `@`.
    `DECLARE @MinAge INT = 18;`
2.  **Условные операторы:** `IF...ELSE`.
    ```sql
    IF @price > 1000 
        PRINT 'Дорого'
    ELSE 
        PRINT 'Дешево';
    ```
3.  **Циклы:** `WHILE`.
4.  **Обработка ошибок:** Блоки `BEGIN TRY ... END TRY` и `BEGIN CATCH ... END CATCH`.
5.  **Глобальные переменные:** Начинаются с `@@` (например, `@@ERROR`, `@@ROWCOUNT`).

---

### 8. Процесс создания транзакций и точек сохранения (Savepoints)

Управление транзакциями позволяет гарантировать целостность данных при выполнении нескольких команд.

*   **Начало:** `BEGIN TRANSACTION;`
*   **Фиксация:** `COMMIT;` (сохранить изменения навсегда).
*   **Откат:** `ROLLBACK;` (вернуть всё в состояние до начала транзакции).
*   **Точка сохранения (SAVEPOINT):** Позволяет откатить транзакцию не полностью, а до определенной промежуточной отметки.
    ```sql
    BEGIN TRANSACTION;
    INSERT ... ;
    SAVE TRANSACTION Point1; -- Создали точку
    UPDATE ... ;
    ROLLBACK TRANSACTION Point1; -- Откатились только до точки (INSERT остался)
    COMMIT; -- Зафиксировали то, что осталось
    ```
